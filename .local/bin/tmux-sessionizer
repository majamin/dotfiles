#!/bin/bash

# Set editor
EDITOR=${EDITOR:-nano}

session_name=$(basename "$PWD")
working_dir=$(realpath "$PWD")

sanitize() {
  echo "$1" | tr -dC '[:alnum:]' | cut -c -16
}

if [ -n "$TMUX" ]; then
  tmux_cmd="tmux switch-client"
else
  tmux_cmd="tmux attach-session"
fi

# ---- Handle arguments ----
if [ "$#" -gt 1 ]; then
  window_name=$(sanitize "$@")
  command="$@"
elif [ "$#" -eq 1 ]; then
  if [ -f "$1" ]; then
    session_name=$(sanitize "$(basename "$(dirname "$(realpath "$1")")")")
    window_name=$(sanitize "$(basename "$1")")
    working_dir=$(dirname "$(realpath "$1")")
    command="$EDITOR '$(realpath "$1")'"
  elif [ -d "$1" ]; then
    working_dir=$(realpath "$1")
    session_name=$(sanitize "$(basename "$working_dir")")
  else
    # check if the argument is a command
    if [ -n `command -v "$1"` ]; then
      command="$@"
      working_dir=$(realpath "$PWD")
    else
      echo "Argument is not a known file, directory or command"
      exit 1
    fi
  fi
else
  session_name=$(sanitize "$(basename "$PWD")")
  tmux_cmd+=" -t $session_name"
fi

# Check if session exists
if tmux has-session -t "$session_name" 2>/dev/null; then
  # do we have a window name? and does it exist?
  if [ -n "$window_name" ]; then
    if tmux list-windows -t "$session_name" | grep -q "$window_name"; then
      tmux_cmd+=" -t $session_name:$window_name"
    else
      tmux new-window -d -n "$window_name" -t "$session_name" -c "$working_dir"
      tmux_cmd+=" -t $session_name:$window_name"
    fi
  else
    tmux_cmd+=" -t $session_name"
  fi
else
  # Create new session and/or window
  if [ -n "$window_name" ]; then
    tmux new-session -d -s "$session_name" -n "$window_name" -c "$working_dir"
    tmux_cmd+=" -t $session_name:$window_name"
  else
    tmux new-session -d -s "$session_name" -c "$working_dir"
    tmux_cmd+=" -t $session_name"
  fi
fi

if [ -n "$command" ]; then
  tmux send-keys -t "$session_name:$window_name" "$command" C-m
fi

# printf "Tmux cmd: %s\n" "$tmux_cmd"
eval $tmux_cmd
